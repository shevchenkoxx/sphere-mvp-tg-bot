# Story Onboarding — Design Document

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:writing-plans to create implementation plan from this design.

**Goal:** Replace the current static /start welcome with a branded, cinematic story that shows users how Sphere works — through a real-feeling narrative, not a feature list. Stories are context-aware (personalized to the community, event, or global mode) and auto-translated via LLM.

**Architecture:** Two story modes (Community/Global + Events), 10-step template with 2 interactive moments, LLM-generated per community context, cached per community+language. Seamless transition into agent onboarding at the end.

---

## Core Principles

1. **Story as vehicle** — every step of the narrative reveals a product feature, but the user experiences a story, not a tutorial
2. **Minimal interactivity** — exactly 2 interactive moments per story (tap → positive feedback). Enough to "feel" the product without overloading
3. **Context-aware** — LLM generates story based on community name, topics, member count. Generic fallback for global mode
4. **Auto-translation** — EN is the golden source. Other languages generated by LLM on first request, then cached
5. **Fast** — total story ~25-30s with interactions. Short messages (2-4 lines each), quick pauses (1.5-2.5s)
6. **Bonus diversity** — 2 bonus use-cases after the main story MUST cover different categories than the main story

---

## Story Modes

### Mode 1: Community / Global

**Trigger:** New user arrives via community deep link or /start without event context.

#### Template (10 Steps)

**Step 1 — Hook** (auto, 2.5s pause after)
```
Sphere

Where meaningful connections happen.

{hook_narrative}

This is how it happened.
```
- `hook_narrative`: LLM-generated teaser about two people in this community. For global mode: "two strangers in a Telegram group."

**Step 2 — Character 1** (2.5s pause)
```
Meet {name_1} — {role_description_1}.
{context_sentence — how they ended up in this community}.

{community_member_count} people. Lots of messages.
{pronoun} didn't know anyone.

Sphere was watching.
```

**Step 3 — Feature: Observation** (2.5s pause)
```
While {name_1} chatted about {topics_from_community} —

Sphere quietly mapped {pronoun_possessive} expertise,
interests, and what makes {pronoun_object} tick.

No forms. No quizzes. Just real conversations.
```

**Step 4 — Feature: Games + INTERACTIVE #1** (user taps)
```
Then a game appeared in the group:

{game_type_emoji} {game_title}

{game_question}
```
Keyboard: 2 options (e.g., `[Option A] | [Option B]`)

After tap:
```
{positive_feedback}! {percentage}% of the group picked the same.

These micro-interactions reveal more about
people than any profile ever could.

{name_1} picked {same_option} too.
```
*(2s pause)*

**Step 5 — Character 2** (2.5s pause)
```
Meanwhile, {name_2} — {role_description_2} —
was in the same group.

{what_name_2_was_doing_in_chat}.

Sphere noticed: {connection_insight — why these two are complementary}.
```

**Step 6 — Feature: AI Matching** (2.5s pause)
```
Sphere's AI connected the dots:

{bullet_1 — shared interest/value}
{bullet_2 — what person 1 needs}
{bullet_3 — what person 2 offers}
{bullet_4 — compatibility score}

It sent them both a private message.
```

**Step 7 — INTERACTIVE #2: Match Preview** (user taps)
```
Here's what {name_1} saw:

---

{match_card — formatted like real match card with name, role,
"Why you'd click" explanation, and icebreaker suggestion}

---
```
Keyboard: `[See what happened next]`

After tap:

**Step 8 — Resolution** (2.5s pause)
```
{resolution_narrative — what happened after the match.
Must be concrete: they built something, started working together,
became friends, etc.}

None of this would have happened in a
{member_count}-person group chat.
```

**Step 9 — Bonus Use Cases** (2s pause)
```
And it's not just about {main_story_category}:

{emoji_1} {bonus_example_1 — 2-3 lines, DIFFERENT category}

{emoji_2} {bonus_example_2 — 2-3 lines, DIFFERENT category again}
```

**Category pool for bonus examples:**
- `professional` — cofounders, jobs, collaborations
- `friendship` — sports partners, hobby buddies, weekly hangouts
- `dating` — relationships that started from shared interests
- `mentorship` — senior/junior connections, career guidance
- `relocation` — new city, finding your people
- `activity` — walks, tennis, running groups

**Rule:** If main story is `professional`, bonus MUST pick from other categories. All 3 categories in the story must be unique.

**Step 10 — CTA** (transition to onboarding)
```
Your turn.

Tell me about yourself and I'll find
people you should know.

One voice message or a few texts —
that's all it takes.
```
Keyboard: `[Let's go]`

Tap → launches `start_agent_onboarding()` with community context preserved in FSM state.

---

### Mode 2: Events

**Trigger:** New user arrives via event deep link, or accesses event creation for the first time.

#### Template (7 Steps)

**Step 1 — Hook** (2.5s pause)
```
What if your next event ran itself?

{event_hook_narrative — about an organizer
who spent zero time on introductions}
```

**Step 2 — Create (feature: simplicity)** (2s pause)
```
It started with one message:

  /quickevent {example_event_name}

That's it. Sphere created the event page,
generated a QR code, and gave {organizer_name}
a link to share.

30 seconds. Done.
```

**Step 3 — Share & Fill (feature: viral loop)** (2.5s pause)
```
{organizer_name} dropped the link in {N} group chats.

People clicked, quick voice intro, profile ready.

In {time_period}: {participant_count} people signed up.

Sphere was already analyzing who
should meet whom.
```

**Step 4 — INTERACTIVE: Match Preview** (user taps)
```
Here's what attendees saw the morning of the event:

---

{top_3_matches_preview — formatted as numbered list
with names, roles, and one-line "why" for each}

---

Imagine walking in and already knowing
the 3 most interesting people to find.
```
Keyboard: `[See what happened at the event]`

After tap:

**Step 5 — Resolution** (2s pause)
```
{participant_count} people. {connections_count} meaningful connections made.

"{testimonial_quote}"
 — attendee feedback

{organizer_name} didn't plan a single icebreaker.
Sphere did all the matching.
```

**Step 6 — Bonus Examples (real-life micro-events)** (2.5s pause)
```
People create all kinds of events:

{walk_emoji} Sunday walk in the park — 3 strangers joined,
turned into a weekly tradition

{sport_emoji} A couple looking for tennis partners —
found 4 people nearby, now they play every Sunday

{concert_emoji} Going to a concert alone?
Sphere finds people with the same taste
who are also going
```

**Step 7 — Value Message + CTA** (2s pause)
```
Here's the thing:

You create an event in 30 seconds.
Share the link.

Then forget about it.

Sphere works in the background —
finding the right people,
matching them by interests,
telling everyone who to talk to.

You show up. The connections are already there.
```
*(1.5s pause)*

```
Your turn.
```
Keyboard: `[Create an event] | [Join one]`

---

## Mode Selection Logic

| Entry Point | Story Mode | Context for LLM |
|------------|-----------|-----------------|
| `community_{uuid}` deep link | Community | community name, topics, member_count |
| `/start` (no args, new user) | Global | none (use hardcoded EN default) |
| `event_{code}` deep link | Events | event name, participant_count |
| `/create_event` or events menu (first time) | Events | none (generic event story) |
| Returning user (already onboarded) | Skip | show menu directly |

---

## LLM Story Generation

### Prompt Structure

```
You are a storytelling engine for Sphere, a Telegram bot that connects
people in communities through AI matching.

Generate a branded onboarding story for a new user.

MODE: {community|global|event}
COMMUNITY_NAME: {name or "none"}
MEMBER_COUNT: {number or "unknown"}
TOP_TOPICS: {list or "general"}
LANGUAGE: {en|ru|etc}

TEMPLATE: {the step-by-step template above with placeholders}

RULES:
- Keep each message 2-4 lines max
- Names should feel real and diverse
- The story must feel like it COULD happen in this specific community
- Main story category: pick the most relevant for this community's topics
- Bonus examples: MUST be different categories from main story
- Bonus category pool: professional, friendship, dating, mentorship,
  relocation, activity
- All 3 categories (main + 2 bonus) must be unique
- Tone: warm, confident, premium — not corporate, not casual
- If LANGUAGE is not "en": translate the golden EN template naturally,
  don't transliterate

OUTPUT: JSON with keys step_1 through step_10 (or step_7 for events),
each containing the message text. Include metadata: main_category,
bonus_categories, character_names.
```

### Caching Strategy

```python
# In-memory cache
_story_cache: Dict[str, Dict[str, List[str]]] = {}
# Key format: "{mode}_{context_id}_{lang}"
# Examples:
#   "community_abc123_en" → [step1, step2, ..., step10]
#   "global_default_ru" → [step1, step2, ..., step10]
#   "event_POSTSW24_en" → [step1, step2, ..., step7]

# Cache is in-memory (dict), reset on deploy
# One LLM call per unique (community, language) pair
# Global EN story is hardcoded (no LLM call needed)
```

### Translation Strategy

- **EN:** Golden source. Community stories = LLM-generated. Global default = hardcoded.
- **Other languages:** LLM translates on first request per context+lang. Cached after.
- **Key languages (RU, etc.):** Can be overridden with hand-written translations later.

---

## Interactive Moments

### Community/Global Story — Interaction #1: Mini Game

- Show a "This or That" style question relevant to community topics
- 2-button inline keyboard
- On tap: show percentage + positive reinforcement
- Purpose: user FEELS the game mechanic, gets micro-dopamine hit

### Community/Global Story — Interaction #2: Match Preview

- Show a realistic match card (formatted like the real thing)
- 1-button inline keyboard: "See what happened next"
- On tap: show the resolution (concrete outcome)
- Purpose: user SEES what a match looks like, anticipates their own

### Events Story — Interaction: Top 3 Preview

- Show formatted "Your Top 3 at {event}" with names + one-liners
- 1-button: "See what happened at the event"
- On tap: show results + testimonial
- Purpose: user imagines themselves receiving this before an event

---

## Technical Integration

### Entry Point Changes

In `start.py`, the `/start` handler for NEW users:

```
BEFORE:
  new user → detect lang → start_agent_onboarding()

AFTER:
  new user → detect lang → detect mode (community/global/event)
  → get_or_generate_story(mode, context, lang)
  → play_story(steps, interactive_callbacks)
  → on CTA tap → start_agent_onboarding() with FSM context preserved
```

### New Files

- `core/services/story_service.py` — story generation, caching, LLM calls
- `adapters/telegram/handlers/story_onboarding.py` — message sending, delays, interactive callbacks

### Modified Files

- `adapters/telegram/handlers/start.py` — redirect new users to story before onboarding
- `adapters/telegram/keyboards/inline.py` — story interaction keyboards
- `adapters/telegram/loader.py` — wire story_service

### FSM States

New states in `states/onboarding.py`:
- `StoryOnboarding.playing` — story is being displayed
- `StoryOnboarding.interactive_1` — waiting for game tap
- `StoryOnboarding.interactive_2` — waiting for match preview tap

### Callback Patterns

- `story_game_{option}` — interactive #1 (game choice)
- `story_next` — interactive #2 (see what happened)
- `story_start_onboarding` — CTA (let's go)
- `story_create_event` — events CTA
- `story_join_event` — events CTA

---

## Edge Cases

1. **User spams /start during story** — clear FSM, restart story
2. **User sends text during story** — ignore (story is auto-playing with pauses)
3. **User already onboarded** — skip story, show menu
4. **LLM generation fails** — fall back to hardcoded EN global story
5. **Community has no topics yet** — use community name + generic narrative
6. **Story cache grows too large** — LRU eviction at 100 entries (more than enough)

---

## Success Metrics

- **Completion rate:** % of users who reach CTA step (vs drop off mid-story)
- **Interaction rate:** % who tap interactive buttons (vs waiting for timeout)
- **Onboarding conversion:** % who tap "Let's go" and complete onboarding
- **Compare:** A/B test story onboarding vs direct agent onboarding (if enough traffic)

---

## Research References

- [Buffer: Good Hooks — How to Grab and Keep Attention](https://buffer.com/resources/good-hooks/)
- [Formbricks: User Onboarding Best Practices 2026](https://formbricks.com/blog/user-onboarding-best-practices)
- [DesignerUp: 200 Onboarding Flows Study](https://designerup.co/blog/i-studied-the-ux-ui-of-over-200-onboarding-flows-heres-everything-i-learned/)
- [PMC: The Connection Prescription](https://pmc.ncbi.nlm.nih.gov/articles/PMC6125010/)
- [TechCrunch: Bumble BFF Community Relaunch](https://techcrunch.com/2025/09/18/bumble-bffs-revamped-app-is-here-focusing-on-friend-groups-and-community-building/)
- [How They Grow: How Bumble Grows](https://www.howtheygrow.co/p/how-bumble-grows)
